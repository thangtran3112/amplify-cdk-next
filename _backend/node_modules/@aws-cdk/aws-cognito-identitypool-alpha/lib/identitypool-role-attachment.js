"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.IdentityPoolRoleAttachment = exports.RoleMappingMatchType = void 0;
const jsiiDeprecationWarnings = require("../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const core_1 = require("aws-cdk-lib/core");
/**
 * Types of matches allowed for Role Mapping
 */
var RoleMappingMatchType;
(function (RoleMappingMatchType) {
    /**
     * The Claim from the token must equal the given value in order for a match
     */
    RoleMappingMatchType["EQUALS"] = "Equals";
    /**
     * The Claim from the token must contain the given value in order for a match
     */
    RoleMappingMatchType["CONTAINS"] = "Contains";
    /**
     * The Claim from the token must start with the given value in order for a match
     */
    RoleMappingMatchType["STARTS_WITH"] = "StartsWith";
    /**
     * The Claim from the token must not equal the given value in order for a match
     */
    RoleMappingMatchType["NOTEQUAL"] = "NotEqual";
})(RoleMappingMatchType || (exports.RoleMappingMatchType = RoleMappingMatchType = {}));
/**
 * Defines an Identity Pool Role Attachment
 *
 * @resource AWS::Cognito::IdentityPoolRoleAttachment
 */
class IdentityPoolRoleAttachment extends core_1.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_cognito_identitypool_alpha_IdentityPoolRoleAttachmentProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, IdentityPoolRoleAttachment);
            }
            throw error;
        }
        this.identityPoolId = props.identityPool.identityPoolId;
        const mappings = props.roleMappings || [];
        let roles = undefined, roleMappings = undefined;
        if (props.authenticatedRole || props.unauthenticatedRole) {
            roles = {};
            if (props.authenticatedRole)
                roles.authenticated = props.authenticatedRole.roleArn;
            if (props.unauthenticatedRole)
                roles.unauthenticated = props.unauthenticatedRole.roleArn;
        }
        if (mappings) {
            roleMappings = this.configureRoleMappings(...mappings);
        }
        new aws_cognito_1.CfnIdentityPoolRoleAttachment(this, 'Resource', {
            identityPoolId: this.identityPoolId,
            roles,
            roleMappings,
        });
    }
    /**
     * Configures Role Mappings for Identity Pool Role Attachment
     */
    configureRoleMappings(...props) {
        if (!props || !props.length)
            return undefined;
        return props.reduce((acc, prop) => {
            let mappingKey;
            if (prop.mappingKey) {
                mappingKey = prop.mappingKey;
            }
            else {
                const providerUrl = prop.providerUrl.value;
                if (core_1.Token.isUnresolved(providerUrl)) {
                    throw new Error('mappingKey must be provided when providerUrl.value is a token');
                }
                mappingKey = providerUrl;
            }
            let roleMapping = {
                ambiguousRoleResolution: prop.resolveAmbiguousRoles ? 'AuthenticatedRole' : 'Deny',
                type: prop.useToken ? 'Token' : 'Rules',
                identityProvider: prop.providerUrl.value,
            };
            if (roleMapping.type === 'Rules') {
                if (!prop.rules) {
                    throw new Error('IdentityPoolRoleMapping.rules is required when useToken is false');
                }
                roleMapping.rulesConfiguration = {
                    rules: prop.rules.map(rule => {
                        return {
                            claim: rule.claim,
                            value: rule.claimValue,
                            matchType: rule.matchType || RoleMappingMatchType.EQUALS,
                            roleArn: rule.mappedRole.roleArn,
                        };
                    }),
                };
            }
            ;
            acc[mappingKey] = roleMapping;
            return acc;
        }, {});
    }
}
exports.IdentityPoolRoleAttachment = IdentityPoolRoleAttachment;
_a = JSII_RTTI_SYMBOL_1;
IdentityPoolRoleAttachment[_a] = { fqn: "@aws-cdk/aws-cognito-identitypool-alpha.IdentityPoolRoleAttachment", version: "2.116.1-alpha.0" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlbnRpdHlwb29sLXJvbGUtYXR0YWNobWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImlkZW50aXR5cG9vbC1yb2xlLWF0dGFjaG1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEseURBRWlDO0FBSWpDLDJDQUkwQjtBQXFGMUI7O0dBRUc7QUFDSCxJQUFZLG9CQW9CWDtBQXBCRCxXQUFZLG9CQUFvQjtJQUM5Qjs7T0FFRztJQUNILHlDQUFpQixDQUFBO0lBRWpCOztPQUVHO0lBQ0gsNkNBQXFCLENBQUE7SUFFckI7O09BRUc7SUFDSCxrREFBMEIsQ0FBQTtJQUUxQjs7T0FFRztJQUNILDZDQUFxQixDQUFBO0FBQ3ZCLENBQUMsRUFwQlcsb0JBQW9CLG9DQUFwQixvQkFBb0IsUUFvQi9CO0FBNEJEOzs7O0dBSUc7QUFDSCxNQUFhLDBCQUEyQixTQUFRLGVBQVE7SUFNdEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQztRQUM5RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDOzs7Ozs7K0NBUFIsMEJBQTBCOzs7O1FBUW5DLElBQUksQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUM7UUFDeEQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDMUMsSUFBSSxLQUFLLEdBQVEsU0FBUyxFQUFFLFlBQVksR0FBUSxTQUFTLENBQUM7UUFDMUQsSUFBSSxLQUFLLENBQUMsaUJBQWlCLElBQUksS0FBSyxDQUFDLG1CQUFtQixFQUFFO1lBQ3hELEtBQUssR0FBRyxFQUFFLENBQUM7WUFDWCxJQUFJLEtBQUssQ0FBQyxpQkFBaUI7Z0JBQUUsS0FBSyxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDO1lBQ25GLElBQUksS0FBSyxDQUFDLG1CQUFtQjtnQkFBRSxLQUFLLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUM7U0FDMUY7UUFDRCxJQUFJLFFBQVEsRUFBRTtZQUNaLFlBQVksR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQztTQUN4RDtRQUNELElBQUksMkNBQTZCLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUNsRCxjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWM7WUFDbkMsS0FBSztZQUNMLFlBQVk7U0FDYixDQUFDLENBQUM7S0FDSjtJQUVEOztPQUVHO0lBQ0sscUJBQXFCLENBQzNCLEdBQUcsS0FBZ0M7UUFFbkMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNO1lBQUUsT0FBTyxTQUFTLENBQUM7UUFDOUMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ2hDLElBQUksVUFBVSxDQUFDO1lBQ2YsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNuQixVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQzthQUM5QjtpQkFBTTtnQkFDTCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQztnQkFDM0MsSUFBSSxZQUFLLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFO29CQUNuQyxNQUFNLElBQUksS0FBSyxDQUFDLCtEQUErRCxDQUFDLENBQUM7aUJBQ2xGO2dCQUNELFVBQVUsR0FBRyxXQUFXLENBQUM7YUFDMUI7WUFFRCxJQUFJLFdBQVcsR0FBUTtnQkFDckIsdUJBQXVCLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsTUFBTTtnQkFDbEYsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTztnQkFDdkMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLO2FBQ3pDLENBQUM7WUFDRixJQUFJLFdBQVcsQ0FBQyxJQUFJLEtBQUssT0FBTyxFQUFFO2dCQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtvQkFDZixNQUFNLElBQUksS0FBSyxDQUFDLGtFQUFrRSxDQUFDLENBQUM7aUJBQ3JGO2dCQUNELFdBQVcsQ0FBQyxrQkFBa0IsR0FBRztvQkFDL0IsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO3dCQUMzQixPQUFPOzRCQUNMLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSzs0QkFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVOzRCQUN0QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsSUFBSSxvQkFBb0IsQ0FBQyxNQUFNOzRCQUN4RCxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPO3lCQUNqQyxDQUFDO29CQUNKLENBQUMsQ0FBQztpQkFDSCxDQUFDO2FBQ0g7WUFBQSxDQUFDO1lBQ0YsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFdBQVcsQ0FBQztZQUM5QixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUEwRSxDQUFDLENBQUM7S0FDaEY7O0FBcEVILGdFQXFFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0byc7XG5pbXBvcnQge1xuICBJUm9sZSxcbn0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQge1xuICBSZXNvdXJjZSxcbiAgSVJlc291cmNlLFxuICBUb2tlbixcbn0gZnJvbSAnYXdzLWNkay1saWIvY29yZSc7XG5pbXBvcnQge1xuICBDb25zdHJ1Y3QsXG59IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgSUlkZW50aXR5UG9vbCxcbiAgSWRlbnRpdHlQb29sUHJvdmlkZXJVcmwsXG59IGZyb20gJy4vaWRlbnRpdHlwb29sJztcblxuLyoqXG4gKiBSZXByZXNlbnRzIGFuIElkZW50aXR5IFBvb2wgUm9sZSBBdHRhY2htZW50XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSUlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50IGV4dGVuZHMgSVJlc291cmNlIHtcbiAgLyoqXG4gICAqIElkIG9mIHRoZSBBdHRhY2htZW50cyBVbmRlcmx5aW5nIElkZW50aXR5IFBvb2xcbiAgICovXG4gIHJlYWRvbmx5IGlkZW50aXR5UG9vbElkOiBzdHJpbmc7XG59XG5cbi8qKlxuICogUHJvcHMgZm9yIGFuIElkZW50aXR5IFBvb2wgUm9sZSBBdHRhY2htZW50XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnRQcm9wcyB7XG5cbiAgLyoqXG4gICAqIElkIG9mIHRoZSBBdHRhY2htZW50cyBVbmRlcmx5aW5nIElkZW50aXR5IFBvb2xcbiAgICovXG4gIHJlYWRvbmx5IGlkZW50aXR5UG9vbDogSUlkZW50aXR5UG9vbDtcblxuICAvKipcbiAgICogRGVmYXVsdCBBdXRoZW50aWNhdGVkIChVc2VyKSBSb2xlXG4gICAqIEBkZWZhdWx0IC0gTm8gZGVmYXVsdCBhdXRoZW50aWNhdGVkIHJvbGUgd2lsbCBiZSBhZGRlZFxuICAgKi9cbiAgcmVhZG9ubHkgYXV0aGVudGljYXRlZFJvbGU/OiBJUm9sZTtcblxuICAvKipcbiAgICAqIERlZmF1bHQgVW5hdXRoZW50aWNhdGVkIChHdWVzdCkgUm9sZVxuICAgICogQGRlZmF1bHQgLSBObyBkZWZhdWx0IHVuYXV0aGVudGljYXRlZCByb2xlIHdpbGwgYmUgYWRkZWRcbiAgICAqL1xuICByZWFkb25seSB1bmF1dGhlbnRpY2F0ZWRSb2xlPzogSVJvbGU7XG5cbiAgLyoqXG4gICAqIFJ1bGVzIGZvciBtYXBwaW5nIHJvbGVzIHRvIHVzZXJzXG4gICAqIEBkZWZhdWx0IC0gbm8gUm9sZSBNYXBwaW5nc1xuICAgKi9cbiAgcmVhZG9ubHkgcm9sZU1hcHBpbmdzPzogSWRlbnRpdHlQb29sUm9sZU1hcHBpbmdbXTtcbn1cblxuLyoqXG4gKiBNYXAgcm9sZXMgdG8gdXNlcnMgaW4gdGhlIGlkZW50aXR5IHBvb2wgYmFzZWQgb24gY2xhaW1zIGZyb20gdGhlIElkZW50aXR5IFByb3ZpZGVyXG4gKiAgQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQVdTQ2xvdWRGb3JtYXRpb24vbGF0ZXN0L1VzZXJHdWlkZS9hd3MtcmVzb3VyY2UtY29nbml0by1pZGVudGl0eXBvb2xyb2xlYXR0YWNobWVudC5odG1sXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlQb29sUm9sZU1hcHBpbmcge1xuICAvKipcbiAgICogVGhlIHVybCBvZiB0aGUgcHJvdmlkZXIgb2YgZm9yIHdoaWNoIHRoZSByb2xlIGlzIG1hcHBlZFxuICAgKi9cbiAgcmVhZG9ubHkgcHJvdmlkZXJVcmw6IElkZW50aXR5UG9vbFByb3ZpZGVyVXJsO1xuXG4gIC8qKlxuICAgKiBUaGUga2V5IHVzZWQgZm9yIHRoZSByb2xlIG1hcHBpbmcgaW4gdGhlIHJvbGUgbWFwcGluZyBoYXNoLiBSZXF1aXJlZCBpZiB0aGUgcHJvdmlkZXJVcmwgaXMgYSB0b2tlbi5cbiAgICogQGRlZmF1bHQgLSB0aGUgcHJvdmlkZWQgcHJvdmlkZXJVcmxcbiAgICovXG4gIHJlYWRvbmx5IG1hcHBpbmdLZXk/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqICBJZiB0cnVlIHRoZW4gbWFwcGVkIHJvbGVzIG11c3QgYmUgcGFzc2VkIHRocm91Z2ggdGhlIGNvZ25pdG86cm9sZXMgb3IgY29nbml0bzpwcmVmZXJyZWRfcm9sZSBjbGFpbXMgZnJvbSBpZGVudGl0eSBwcm92aWRlci5cbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY29nbml0by9sYXRlc3QvZGV2ZWxvcGVyZ3VpZGUvcm9sZS1iYXNlZC1hY2Nlc3MtY29udHJvbC5odG1sI3VzaW5nLXRva2Vucy10by1hc3NpZ24tcm9sZXMtdG8tdXNlcnNcbiAgICpcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IHVzZVRva2VuPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogQWxsb3cgZm9yIHJvbGUgYXNzdW1wdGlvbiB3aGVuIHJlc3VsdHMgb2Ygcm9sZSBtYXBwaW5nIGFyZSBhbWJpZ3VvdXNcbiAgICogQGRlZmF1bHQgZmFsc2UgLSBBbWJpZ3VvdXMgcm9sZSByZXNvbHV0aW9ucyB3aWxsIGxlYWQgdG8gcmVxdWVzdGVyIGJlaW5nIGRlbmllZFxuICAgKi9cbiAgcmVhZG9ubHkgcmVzb2x2ZUFtYmlndW91c1JvbGVzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIGNsYWltIGFuZCB2YWx1ZSB0aGF0IG11c3QgYmUgbWF0Y2hlZCBpbiBvcmRlciB0byBhc3N1bWUgdGhlIHJvbGUuIFJlcXVpcmVkIGlmIHVzZVRva2VuIGlzIGZhbHNlXG4gICAqIEBkZWZhdWx0IC0gTm8gUnVsZSBNYXBwaW5nIFJ1bGVcbiAgICovXG4gIHJlYWRvbmx5IHJ1bGVzPzogUm9sZU1hcHBpbmdSdWxlW107XG59XG5cbi8qKlxuICogVHlwZXMgb2YgbWF0Y2hlcyBhbGxvd2VkIGZvciBSb2xlIE1hcHBpbmdcbiAqL1xuZXhwb3J0IGVudW0gUm9sZU1hcHBpbmdNYXRjaFR5cGUge1xuICAvKipcbiAgICogVGhlIENsYWltIGZyb20gdGhlIHRva2VuIG11c3QgZXF1YWwgdGhlIGdpdmVuIHZhbHVlIGluIG9yZGVyIGZvciBhIG1hdGNoXG4gICAqL1xuICBFUVVBTFMgPSAnRXF1YWxzJyxcblxuICAvKipcbiAgICogVGhlIENsYWltIGZyb20gdGhlIHRva2VuIG11c3QgY29udGFpbiB0aGUgZ2l2ZW4gdmFsdWUgaW4gb3JkZXIgZm9yIGEgbWF0Y2hcbiAgICovXG4gIENPTlRBSU5TID0gJ0NvbnRhaW5zJyxcblxuICAvKipcbiAgICogVGhlIENsYWltIGZyb20gdGhlIHRva2VuIG11c3Qgc3RhcnQgd2l0aCB0aGUgZ2l2ZW4gdmFsdWUgaW4gb3JkZXIgZm9yIGEgbWF0Y2hcbiAgICovXG4gIFNUQVJUU19XSVRIID0gJ1N0YXJ0c1dpdGgnLFxuXG4gIC8qKlxuICAgKiBUaGUgQ2xhaW0gZnJvbSB0aGUgdG9rZW4gbXVzdCBub3QgZXF1YWwgdGhlIGdpdmVuIHZhbHVlIGluIG9yZGVyIGZvciBhIG1hdGNoXG4gICAqL1xuICBOT1RFUVVBTCA9ICdOb3RFcXVhbCcsXG59XG5cbi8qKlxuICogUmVwcmVzZW50cyBhbiBJZGVudGl0eSBQb29sIFJvbGUgQXR0YWNobWVudCBSb2xlIE1hcHBpbmcgUnVsZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJvbGVNYXBwaW5nUnVsZSB7XG4gIC8qKlxuICAgKiBUaGUga2V5IHNlbnQgaW4gdGhlIHRva2VuIGJ5IHRoZSBmZWRlcmF0ZWQgaWRlbnRpdHkgcHJvdmlkZXIuXG4gICAqL1xuICByZWFkb25seSBjbGFpbTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgUm9sZSB0byBiZSBhc3N1bWVkIHdoZW4gQ2xhaW0gVmFsdWUgaXMgbWF0Y2hlZC5cbiAgICovXG4gIHJlYWRvbmx5IG1hcHBlZFJvbGU6IElSb2xlO1xuXG4gIC8qKlxuICAgKiBUaGUgdmFsdWUgb2YgdGhlIGNsYWltIHRoYXQgbXVzdCBiZSBtYXRjaGVkXG4gICAqL1xuICByZWFkb25seSBjbGFpbVZhbHVlOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEhvdyB0byBtYXRjaCB3aXRoIHRoZSBDbGFpbSB2YWx1ZVxuICAgKiBAZGVmYXVsdCBSb2xlTWFwcGluZ01hdGNoVHlwZS5FUVVBTFNcbiAgKi9cbiAgcmVhZG9ubHkgbWF0Y2hUeXBlPzogUm9sZU1hcHBpbmdNYXRjaFR5cGVcbn1cblxuLyoqXG4gKiBEZWZpbmVzIGFuIElkZW50aXR5IFBvb2wgUm9sZSBBdHRhY2htZW50XG4gKlxuICogQHJlc291cmNlIEFXUzo6Q29nbml0bzo6SWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnRcbiAqL1xuZXhwb3J0IGNsYXNzIElkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50IGV4dGVuZHMgUmVzb3VyY2UgaW1wbGVtZW50cyBJSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQge1xuICAvKipcbiAgICogSWQgb2YgdGhlIHVuZGVybHlpbmcgaWRlbnRpdHkgcG9vbFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGlkZW50aXR5UG9vbElkOiBzdHJpbmdcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnRQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgdGhpcy5pZGVudGl0eVBvb2xJZCA9IHByb3BzLmlkZW50aXR5UG9vbC5pZGVudGl0eVBvb2xJZDtcbiAgICBjb25zdCBtYXBwaW5ncyA9IHByb3BzLnJvbGVNYXBwaW5ncyB8fCBbXTtcbiAgICBsZXQgcm9sZXM6IGFueSA9IHVuZGVmaW5lZCwgcm9sZU1hcHBpbmdzOiBhbnkgPSB1bmRlZmluZWQ7XG4gICAgaWYgKHByb3BzLmF1dGhlbnRpY2F0ZWRSb2xlIHx8IHByb3BzLnVuYXV0aGVudGljYXRlZFJvbGUpIHtcbiAgICAgIHJvbGVzID0ge307XG4gICAgICBpZiAocHJvcHMuYXV0aGVudGljYXRlZFJvbGUpIHJvbGVzLmF1dGhlbnRpY2F0ZWQgPSBwcm9wcy5hdXRoZW50aWNhdGVkUm9sZS5yb2xlQXJuO1xuICAgICAgaWYgKHByb3BzLnVuYXV0aGVudGljYXRlZFJvbGUpIHJvbGVzLnVuYXV0aGVudGljYXRlZCA9IHByb3BzLnVuYXV0aGVudGljYXRlZFJvbGUucm9sZUFybjtcbiAgICB9XG4gICAgaWYgKG1hcHBpbmdzKSB7XG4gICAgICByb2xlTWFwcGluZ3MgPSB0aGlzLmNvbmZpZ3VyZVJvbGVNYXBwaW5ncyguLi5tYXBwaW5ncyk7XG4gICAgfVxuICAgIG5ldyBDZm5JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudCh0aGlzLCAnUmVzb3VyY2UnLCB7XG4gICAgICBpZGVudGl0eVBvb2xJZDogdGhpcy5pZGVudGl0eVBvb2xJZCxcbiAgICAgIHJvbGVzLFxuICAgICAgcm9sZU1hcHBpbmdzLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbmZpZ3VyZXMgUm9sZSBNYXBwaW5ncyBmb3IgSWRlbnRpdHkgUG9vbCBSb2xlIEF0dGFjaG1lbnRcbiAgICovXG4gIHByaXZhdGUgY29uZmlndXJlUm9sZU1hcHBpbmdzKFxuICAgIC4uLnByb3BzOiBJZGVudGl0eVBvb2xSb2xlTWFwcGluZ1tdXG4gICk6IHsgW25hbWU6c3RyaW5nXTogQ2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQuUm9sZU1hcHBpbmdQcm9wZXJ0eSB9IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoIXByb3BzIHx8ICFwcm9wcy5sZW5ndGgpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgcmV0dXJuIHByb3BzLnJlZHVjZSgoYWNjLCBwcm9wKSA9PiB7XG4gICAgICBsZXQgbWFwcGluZ0tleTtcbiAgICAgIGlmIChwcm9wLm1hcHBpbmdLZXkpIHtcbiAgICAgICAgbWFwcGluZ0tleSA9IHByb3AubWFwcGluZ0tleTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyVXJsID0gcHJvcC5wcm92aWRlclVybC52YWx1ZTtcbiAgICAgICAgaWYgKFRva2VuLmlzVW5yZXNvbHZlZChwcm92aWRlclVybCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ21hcHBpbmdLZXkgbXVzdCBiZSBwcm92aWRlZCB3aGVuIHByb3ZpZGVyVXJsLnZhbHVlIGlzIGEgdG9rZW4nKTtcbiAgICAgICAgfVxuICAgICAgICBtYXBwaW5nS2V5ID0gcHJvdmlkZXJVcmw7XG4gICAgICB9XG5cbiAgICAgIGxldCByb2xlTWFwcGluZzogYW55ID0ge1xuICAgICAgICBhbWJpZ3VvdXNSb2xlUmVzb2x1dGlvbjogcHJvcC5yZXNvbHZlQW1iaWd1b3VzUm9sZXMgPyAnQXV0aGVudGljYXRlZFJvbGUnIDogJ0RlbnknLFxuICAgICAgICB0eXBlOiBwcm9wLnVzZVRva2VuID8gJ1Rva2VuJyA6ICdSdWxlcycsXG4gICAgICAgIGlkZW50aXR5UHJvdmlkZXI6IHByb3AucHJvdmlkZXJVcmwudmFsdWUsXG4gICAgICB9O1xuICAgICAgaWYgKHJvbGVNYXBwaW5nLnR5cGUgPT09ICdSdWxlcycpIHtcbiAgICAgICAgaWYgKCFwcm9wLnJ1bGVzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJZGVudGl0eVBvb2xSb2xlTWFwcGluZy5ydWxlcyBpcyByZXF1aXJlZCB3aGVuIHVzZVRva2VuIGlzIGZhbHNlJyk7XG4gICAgICAgIH1cbiAgICAgICAgcm9sZU1hcHBpbmcucnVsZXNDb25maWd1cmF0aW9uID0ge1xuICAgICAgICAgIHJ1bGVzOiBwcm9wLnJ1bGVzLm1hcChydWxlID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGNsYWltOiBydWxlLmNsYWltLFxuICAgICAgICAgICAgICB2YWx1ZTogcnVsZS5jbGFpbVZhbHVlLFxuICAgICAgICAgICAgICBtYXRjaFR5cGU6IHJ1bGUubWF0Y2hUeXBlIHx8IFJvbGVNYXBwaW5nTWF0Y2hUeXBlLkVRVUFMUyxcbiAgICAgICAgICAgICAgcm9sZUFybjogcnVsZS5tYXBwZWRSb2xlLnJvbGVBcm4sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pLFxuICAgICAgICB9O1xuICAgICAgfTtcbiAgICAgIGFjY1ttYXBwaW5nS2V5XSA9IHJvbGVNYXBwaW5nO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSBhcyB7IFtuYW1lOnN0cmluZ106IENmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LlJvbGVNYXBwaW5nUHJvcGVydHkgfSk7XG4gIH1cbn0iXX0=